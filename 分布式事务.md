# 分布式事务

同时操作的表不在一个物理节点,那么本地事务就没有了意义

## 事务特性

ACID:原子性,一致性,隔离性,持久性

原子:原子操作,要么都成功,要么都不成功

一致:预期结果和执行完事务之后结果相同

隔离:各个事务之间互不影响

持久:一旦事务完成,事务对数据所做的操作就完全保存在了数据库中

## 隔离级别

更新丢失:	两个事务同时更新,后面事务覆盖了之前事务的更新

脏读:	事务A读到了事务B还未提交的数据,如果事务B回滚,则事务A读到是脏数据

不可重复读:	事务A读取之后,事务B对其进行了修改,当事务A再次读取时,读不到之前读到的数据

幻读:	事务A读取时,事务B又插入了一些数据,事务A再次读取时,有的数据消失,有的数据额外显示,像是幻觉



不可重复读和脏读的区别:	脏读读的是其他事务未提交的,不可重复读到的是已经提交的

不可重复读和幻读的区别:	不可重复针对的是某一项,幻读针对的是一个区域范围内的数据

## 分布式事务 CPA 理论

事务的参与者,支持事务的服务器,资源服务器以及事务管理器分别位于不同的分布式系统的不同节点上.

C: **数据一致性**:  如果系统对一个写操作返回成功,那么之后的读请求都必须读到这个新的数据,如果返回失败,所有系统都不能读到这个暑假,对于调用者来说具有强一致性

A: **可用性**:所有请求在一定时间内一定会得到响应,可终止,不会一直等待  每一个非故障节点必须对每一个请求做出响应.

P: **分区容错性**  网络分区的情况下,被隔离的节点仍然能正常的对外服务

> **Base理论**: 基本可用,软状态,最终一致性    柔性事务

柔性事务和刚性事务:

刚性事务满足ACID理论

柔性事务为满足BASE理论

1. 两段模型
2. 补偿型
3. 异步确保型
4. 最大努力通知型

## 解决方案

> 两段式,三段式,TCC,提供回滚接口,分布式数据库
>
> LCN核心采用 三段式+TCC补偿机制

### 两段式

第一阶段: 准备阶段

所有的参与者准备执行事务并锁住需要的资源.通知每一方开启事务.然后执行相关操作

第二阶段: 提交阶段

当管理者确认所有参与者都准备好了之后开始提交

### 三段式

> 1. 引入超时机制.同时在协调者和参与者中都引入超时机制
> 2. 在第一阶段和第二阶段中插入一个准备阶段,保证了在最后提交阶段之前各个参与节点的状态是一致

第一阶段:CanCommit

协调者向参与者发送commit请求,参与者如果可以提交就返回Yes响应,否则返回No

第二阶段: PreCommit

协调者根据参与者的反应情况开决定是否可以执行事务的PreCommit操作,根据响应情况,有2种情况

反馈都是yes,就会执行事务的预执行

1. 发送预提交请求 协调者向参与者发送PreCommit请求
2. 事务预提交 参与者接收到PreCommit请求后,会执行事务操作,并将操作记录到事务日志中
3. 响应反馈 如果参与者成功的执行了事务操作,则返回ACK响应,同时开始等待最终指令

假如有任何一个参与者向协调者发送了No响应,或者等待超时之后,协调者都没有接收到参与者的响应,那么旧执行事务中断.

1. 发送中断请求 协调者向所有参与者发送abort请求
2. 中断事务 参与者收到来自协调者的abort请求之后,执行事务的中断

第三阶段:doCommit

执行提交:

1. 发送提交请求 协调接受到参与者发送的ACK响应,那么他将从预提交状态进入提交状态.并向所有参与者发送doCommit请求.
2. 事务提交 参与者接受到doCommit请求之后,执行正式的事物提交.并在完成事务提交之后释放所有事务资源
3. 响应反馈 事务提交完之后,向协调者发送ACK响应
4. 完成事务 协调者接收到所有参与者的ack响应之后,完成事务

中断事务:

1. 发送中断请求 协调者向所有参与者发送abort请求
2. 事务回滚 参与者接收到abort请求之后 利用其在阶段二记录的日志信息来执行事务的回滚操作,并在回滚之后释放所有的事物资源
3. 反馈结果 参与者完成事务回滚之后,向协调者发送ACK消息
4. 中断事务 协调者接收到参与者反馈的ACK消息之后,执行事务的中断

### 两段式和三段式的区别

相较于两段式,三段式主要解决的单独故障问题,并减少阻塞.因为一旦参与者无法及时收到来自协调者的信息之后,他会默认执行commit而不会一直持有事务资源并处于阻塞状态.但是这种机制也会导致数据一致性问题.

## TCC

try-confirm-cancel

1. 在全局事务决定提交时,调用与try业务逻辑相对应的confirm业务逻辑
2. 在全局事务决定回滚时,调用与try业务逻辑相对应的cancel业务逻辑



## MQ分布式事务

采用时效性高的MQ,由对方订阅消息并监听,有消息时自动触发事件 采用定时轮询扫描的方式,去检查消息表的数据.

## 其他补偿



人工为最后一道







