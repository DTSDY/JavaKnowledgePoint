## 项目架构演进

早期OA为主，互联网项目较少。最早为单体项目，写在一起，以servlet为主。偶尔打不开连接不上，没有影响。

### 单体应用

所有的东西都在一起,功能比较少。

servler连接数量有限制，当访问越来越多，我们需要增加服务器（tomcat）。

#### 1、问题一：如何找到新增加的服务器

增加了新的服务器，但是访问者不知道新的服务器。所以我们需要一个**分配者**;

> 集群： 具有相同能的服务器；
>
> 目的：1、某一个节点可能会坏
>
> ​			2、某一个节点无法负载过多请求

#### 2、问题二：**分配者**如何从集群中挑选机器

> 负载均衡：如何从**集群**中挑选一个**服务器**给你提供功能

依靠算法：

​	1、随机：随便指定一机器

​	2、轮询：依次轮流

​	3、哈希：固定指定一个节点

​	3、权重：能者多劳

#### 3、问题三：当使用Session登陆时,如果我们每次访问不同的服务器就需要多次登陆

Session依赖于Cookie,会在Cookie中存放一个JsessionId。我们可以在集群中各个服务器进行同步Session,此时消耗大量资源处理资源同步的问题，效率更低。

> 解决：在不同服务器之间同步数据，优先考虑使用第三方服务器

从第三方服务器中存取的速度应该比较快，考虑 redis，redis集群。

> 缓存问题：1、缓存同步 2、穿透 3、雪崩 4、穿刺 5、倾斜
>
> 为什么使用缓存：减少慢操作（各种慢操作，从磁盘中读取就是慢操作） 慢操作是相对的

**数据库中不存在 删除 和 like，只存在 逻辑删除，将对象标记为删除即可**

1、穿透：大量请求查询数据库中不存在的操作，所以缓存也不存在，到时数据库奔溃

> 主键是自增的：将当前主键的最大值存入缓存中，若大于主键范围，则直接返回不存在，不需要再查询数据库，即过滤请求
>
> 主键不是自增的：第一次从数据库中查询为空时，也写入到缓存中。
>
> > 1、缓存设置的时间
> >
> > 2、大量不同的请求还是查询
>
> 设置一个set集合存放数据中所有的主键，先查主键存不存在与Set集合中,存在才查询数据库，否则在缓存就进行拦截

2、穿刺或击穿：热点数据提前存储在缓存中，但是缓存中的数据突然消失，导致数据库被击穿

> 加锁：保证只有一个人去数据库中查询，防止数据库出问题。因为存在集群中，所以使用分布式锁

3、雪崩：缓存中大量数据在短时间内过期

缓存的越热：提前将一部分热点数据加载到缓存中，防止刚启动时，因为没有缓存导致上面2种情况。

> 缓存设置的有效期不要设置相同的。让他在不同时间内过期；

4、倾斜：同一个key缓存都是同一个，redis缓存崩溃

大量请求请求同一个缓存（节点）,

> 解决使用 多级缓存

Jvm缓存：也可以使用map存储热点数据  Tomcat中缓存时间特别短 消失后再同步

> 主从：将读操作分布到多个节点中



结构 

负载均衡服务器   多个tomcat   redis集群

#### 4、问题四：功能增加之后，需要重新上线，花费大量资源时间

单一职责：一个模块或者类应该只实现一个功能

此时进入分布式阶段



### 分布式应用

单体应用运维成本高，耦合性高

将所有功能拆分，需要什么，就重启什么。

#### 1、问题：如何通过网络请求调用对应的服务

一般不适用http协议，我们使用RPC（远程过程调用）

> 产生原因：不在同一环境中，无法知道节点的添加或者减少，添加的服务的IP，或者那个IP失效

注册中心：一个平台，请求和服务都在这个平台上注册，我们就可以查找到对方

zookeeper、eureka                           提供者、消费者模式

#### 2、问题：如何和注册中心进行通信

zookeeper 可以使用 dubbo                 通过定义好的规则（协议）

#### 3、问题：服务治理：熔断，降级，限流

在调用过程中，可能某一个节点会突然宕机，如何处理？要有良好的交互，不能直接返回异常。

> 降级：原本需要返回给你的值无法返回，我就返回一个默认的值

两地三中心，将服务器分散，防止机房突然断电，网络切割

最常见的问题解决：超时，如果一直没有响应则会超时。

> 熔断：多次请求下游服务出现问题，直接给调用者返回信息，而不再请求

当发生**突发性高并发**，进行限流，否则**崩溃**都会导致**雪崩**

> 灰度发布：测试版本，在同一个注册中心中发布同一个服务的不同版本

nginx解决负载均衡

#### 4、问题：一个业务调用很多功能，是否一定需要实时完成

如果不要，我们可以延迟修改，不用将这些功能写在一起，主要解决：耦合

服务器和服务器之间的通信不一定需要同步，我们可以使用异步。

**MQ**：消息队列，所有异步操作，所有可以使用中间状态的操作

#### 5、问题：RPC依然具有耦合性，通过http调用

模块越来越多，可能不仅仅使用java，服务和服务之间需要使用http调用

此时称为，**微服务**->高度自治,基本达到完全解耦。

使用 eureka

> 跨域：域名+协议+端口   游览器产生的问题，这是一个安全问题

**网关**（路由）：filter 统一处理跨域

#### 6、问题：有特别多的配置文件，需要一个配置文件中心

结构

nginx   Controller 	 网关 	 服务 	 注册中心 	 redis	 配置中心 	MQ

> 监控中心：监控所有服务的运行，失败的原因，条件状态

> 链路追踪：什么时间谁请求了谁，发送了什么，结果是什么

#### 7、CICD：持续集成，持续交付

自动化下载代码，编译，打包，运行，交付

语义化开发规范：git  一键快速部署，一键快速回滚

